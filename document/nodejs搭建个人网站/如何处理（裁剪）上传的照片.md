# 使用node.js如何处理（裁剪）上传的照片

裁剪图片，使用了一个包`gm`

安装：

```
npm install gm
```

### 前端展示

```
<!DOCTYPE html>
<html lang="en">
<head>
  引入js\css
  ......
  jQuery(function($){
    .......
    一些功能
    .......
    // 获取截图的参数
    function updatePreview(c)
    {
      ........
    };
    $("input").click(function () {
      var w = $(".jcrop-holder>div:first").css("width");
      var h = $(".jcrop-holder>div:first").css("height");
      var x = $(".jcrop-holder>div:first").css("left");
      var y = $(".jcrop-holder>div:first").css("top");
      $.get("/doCut",{
        w:w,
        h:h,
        x:x,
        y:y
      },function (data,staut) {
        alert(staut);
        window.location.href="/person";  //当前页面打开URL页面,跳转
      }
    })
  });
</script>

<style type="text/css">
.....
.....
</style>

</head>
<!-----------------这是开始---------------------------->
<body>
<div class="page-header">
.....
</div>
  <img src=<%= avatar %> id="target" class="img-responsive" />
  <div id="preview-pane">
    <div class="preview-container">
      <img src=<%= avatar %>  class="jcrop-preview" alt="Preview" />
    </div>
  </div>
  <div class="description">
    <b>裁剪你的头像</b>
    <h3> </h3>
  </div>
  <div>
    <input type="button" value="裁剪头像" id="cut">
  </div>
</body>
</html>


```

#### 说明

```
$("input").click(function () {.......}
这个功能，是获取裁剪的照片的参数值，width\height\left\top

<img src=<%= avatar %>  class="jcrop-preview" alt="Preview" />
ejs模板引擎，渲染要裁剪的照片
```

----

### 后端处理

引用的中间件，是`gm`和`mongodb`

> 函数功能：裁剪图片，并且把裁剪后的图片名称和路径，更新到数据库中

```
//接受GET的参数，w、h、x、y,用于裁剪图片
exports.executeCut = function (req,res) {
    var filename = req.session.avatar;
    //这个是不能带像素的，需要转换
    var w = parseInt(req.query.w);
    var h = parseInt(req.query.h);
    var x = parseInt(req.query.x);
    var y = parseInt(req.query.y);

    gm("./avatar/"+filename)
        .crop(w,h,x,y)         //裁剪
        .resize(150,150,"!")   //强制转换成150*150
        .write("./avatar/"+filename,function (err) {
        if(err){
            res.send("-1");
            console.log(err);
            return
        }

        db.updateInfo("User",{"UserName": req.session.username},
            {$set:{"avatar":req.session.avatar}},function (err,result) {
            //为什么不会跳转
            if(err){
                res.send(err);
                console.log(err);
                return;
            }
            // res.redirect("/person");   //这个为什么不会被执行？？
            console.log("1");
            res.send("+1");
            return;
        });
    })
}
```

