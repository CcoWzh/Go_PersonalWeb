# 使用node.js如何上传文件

上传文件，使用了一个中间件

```
const formidable = require("formidable");
```

安装：

```
npm install formidable
```

使用注意事项：

>一定要在提交的表单上，要在`from`中加入属性`enctype="multipart/form-data"`

下面，来具体看一下前端提交和后端处理的过程吧

### 前端展示

首先，是前端提交，前端页面如下：

```
<div class="container">
  <form method="post" action="/dosetAvatar"
        ，enctype="multipart/form-data" class="form-inline" role="form">
    <!--这个标签 enctype="multipart/form-data"
    还需要有 name 标签
    一定要写-->
    <div class="form-group">
      <label for="exampleInputFile">选择头像</label>
      <p> 暂无尺寸要求 </p>
      <input type="file" id="exampleInputFile" name="picture">
    </div>
    
    <button type="submit" class="btn btn-default">提交</button>
  </form>
</div>
```

#### 网页说明

`from`标签中，`action="/dosetAvatar"`表示要将表单提交到哪个地方，要哪个路由功能处理，这里，我是提交到头像处理的路由了；

`input`标签中，`name`属性，在后台可以得到name的值

----

### 后台处理

```
//处理提交业务
exports.dosetavatar = function (req,res) {
    var form = new formidable.IncomingForm();
    //设置放置文件上载的目录
    form.uploadDir = "./avatar/";
    //执行里面的回调函数的时候，表单已经全部接收完毕了
    form.parse(req, function (err, fields, files){
        // console.log(files);
        var extname = path.extname(files.picture.name);
        var oldpath = "./" + files.picture.path;
        var newpath = "./avatar/"+req.session.username+extname;
        /**
         * rename 的一个用途，就是移动文件到需要的目录中
         */
        fs.rename(oldpath,newpath,function (err) {
            if(err){
                res.send("上传失败");
                throw  Error("改名失败");
            }
            req.session.avatar = req.session.username+extname;   //TMD,是req,不是res
            // 跳转到剪裁的页面
            res.redirect("/setAvatar");
            // res.send("成功");
            return;
        });
        return;
    })
}
```

#### 代码说明

引入两个中间件：`formidable`、`path`和`fs`,最后设置`session`

##### 函数功能：

> 将表单提交的文件，改名，并保存到`./avatar/`目录下

```
var form = new formidable.IncomingForm();
form.parse(req, function (err, fields, files){.......}
说明：
解析文件，返回三个参数，
err : 错误信息
fields :
files ： 文件信息,格式形如
{ picture:
   File {
     ......
     size: 420269,
     path: 'avatar\\upload_ed8859db1d61f437dbce37f9c7fca088',
     name: '叶韵02.jpg',
     type: 'image/jpeg',
     lastModifiedDate: 2019-05-19T02:29:34.627Z,
     _writeStream:
      WriteStream {
        .......
        path: 'avatar\\upload_ed8859db1d61f437dbce37f9c7fca088',
        fd: null,
        flags: 'w',
        ..... }
       }
 }
 其中，json的第一个元素`picture`就是我们在前端表单中，提交的文件名，`name`属性
```

我们使用`path`模块，获取文件的后缀名：

```
var extname = path.extname(files.picture.name);
```

使用`files`获取文件的原始上传路径

```
var oldpath = "./" + files.picture.path;
```

然后设置`要转移的路径`和`改的名字`

```
var newpath = "./avatar/"+req.session.username+extname;
```

使用`fs`模块，改路径和名字：

```
fs.rename(oldpath,newpath,function (err) {......}
```

设置`session`

```
req.session.avatar = req.session.username+extname;
注意，这里的是`response`，不是`require`.我又一次设置错了，找了好半天的错误，就是设置不上session
```

页面重定向:

```
res.redirect("/setAvatar");
```











